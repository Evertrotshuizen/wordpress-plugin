#!/bin/bash

display_usage() {
  echo -e "Usage:\n\t$0 <version> [IntegrationTestFile.php] \n\nExample:\n\t$0 41"
}

if [ $# -eq 0 ]; then
  display_usage
  exit 1
fi

version="$1"
DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

if [ $# -ge 2 ]
then
  PHPUNIT_ARG="$2"
else
  PHPUNIT_ARG="test/integration"
fi

export WORDPRESS_VERSION=$version
export WORDPRESS_DATABASE=wordpress_$version
export MYSQL_ROOT_PASSWORD=root

if [ -z "$HOST_IP" ]; then
  export HOST_IP=127.0.0.1
fi

export HOST_PORT=80$version
export WORDPRESS_URL=http://wordpress

function prepare_test_config {
  printf "\nPreparing test config\n\n"
  mv src/config/tiny-config.php src/config/tiny-config.php.bak
  mv src/vendor/tinify/Tinify/Client.php src/vendor/tinify/Tinify/Client.php.bak
  cp test/fixtures/tiny-config.php src/config/tiny-config.php
  cp test/fixtures/Client.php src/vendor/tinify/Tinify/Client.php
}

function restore_config {
  printf "\n\nRestoring config\n\n"
  mv src/config/tiny-config.php.bak src/config/tiny-config.php
  mv src/vendor/tinify/Tinify/Client.php.bak src/vendor/tinify/Tinify/Client.php
}

trap 'restore_config' EXIT

prepare_test_config
vendor/bin/phpunit "$PHPUNIT_ARG"
