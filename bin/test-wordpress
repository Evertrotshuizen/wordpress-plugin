#!/bin/bash

if [ -z "${HOST}" ]; then
  export HOST=127.0.0.1
fi

if [ -z "${VERSION}" ]; then
  export VERSION="$1"
fi

export MYSQL_PWD=root
export WORDPRESS_DATABASE=wordpress_${VERSION}
export WORDPRESS_PORT=80${VERSION}
export WORDPRESS_URL=http://wordpress

function prepare_test_config {
  mv src/config/tiny-config.php src/config/tiny-config.php.bak
  mv src/vendor/tinify/Tinify/Client.php src/vendor/tinify/Tinify/Client.php.bak
  cp test/fixtures/tiny-config.php src/config/tiny-config.php
  cp test/fixtures/Client.php src/vendor/tinify/Tinify/Client.php
}

function restore_config {
  mv src/config/tiny-config.php.bak src/config/tiny-config.php
  mv src/vendor/tinify/Tinify/Client.php.bak src/vendor/tinify/Tinify/Client.php
}

trap 'restore_config' EXIT

prepare_test_config
vendor/bin/phpunit test/integration
